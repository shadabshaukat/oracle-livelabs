<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enterprise Search App</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header class="topbar">
    <h1>Enterprise Search</h1>
  </header>

  <main class="container">
    <!-- Hero: Google-like minimalist landing -->
    <section class="card card--wide hero">
      <div class="logo" aria-label="SEARCH">
        <span class="g g-blue">S</span>
        <span class="g g-red">E</span>
        <span class="g g-yellow">A</span>
        <span class="g g-blue">R</span>
        <span class="g g-green">C</span>
        <span class="g g-red">H</span>
      </div>

      <div class="searchbar">
        <input id="query" class="search-input" type="text" placeholder="Search..." />
        <div class="search-actions">
          <button id="searchBtn" class="primary">Search</button>
          <button id="settingsBtn" class="ghost" title="Settings" aria-expanded="false">⚙️</button>
        </div>
      </div>

      <div id="settingsPanel" class="settings" hidden>
        <div class="row wrap">
          <div class="row no-grow">
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="hybrid" selected>Hybrid</option>
              <option value="semantic">Semantic</option>
              <option value="fulltext">Full-text</option>
              <option value="rag">RAG</option>
            </select>
          </div>
          <div class="row no-grow">
            <label for="topk" class="leftpad">Top K</label>
            <input id="topk" type="number" value="6" min="1" max="50" />
          </div>
          <div class="row no-grow">
            <label for="autoSearch" class="leftpad">Auto search</label>
            <input id="autoSearch" type="checkbox" checked />
            <label for="debounceMs" class="leftpad">Debounce (ms)</label>
            <input id="debounceMs" type="number" value="400" min="100" max="2000" />
          </div>
        </div>
      </div>

      <div class="row middle">
        <div class="loader" id="searchLoading" hidden>
          <div class="spinner"></div>
          <span>Searching…</span>
        </div>
      </div>

      <div class="row">
        <label>Answer / Context</label>
        <pre id="answer" class="panel"></pre>
      </div>
      <div class="row">
        <label>Results</label>
        <div id="results" class="results"></div>
      </div>
    </section>

    <!-- Upload -->
    <section class="card">
      <h2>Upload</h2>
      <div class="row wrap">
        <input id="files" type="file" multiple />
        <button id="uploadBtn">Upload & Ingest</button>
        <div class="loader" id="uploadLoading" hidden>
          <div class="spinner small"></div>
          <span>Uploading…</span>
        </div>
      </div>
      <div class="row">
        <pre id="uploadStatus" class="panel"></pre>
      </div>
    </section>

    <!-- Status -->
    <section class="card">
      <h2>Status</h2>
      <div class="row">
        <button id="readyBtn">Check Ready</button>
      </div>
      <div class="row cols">
        <pre id="readyJson" class="panel"></pre>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" hidden></div>

  <script>
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.hidden = false;
      setTimeout(() => { t.hidden = true; t.textContent = ''; }, 3000);
    }

    function escapeHtml(s) {
      return (s || '').replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
    }

    function highlight(text, query) {
      if (!query) return escapeHtml(text);
      try {
        const esc = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(esc, 'ig');
        return escapeHtml(text).replace(re, m => `<mark>${escapeHtml(m)}</mark>`);
      } catch {
        return escapeHtml(text);
      }
    }

    async function api(path, opts={}) {
      const res = await fetch(path, {
        method: opts.method || 'GET',
        headers: opts.body instanceof FormData ? undefined : { 'Content-Type': 'application/json' },
        body: opts.body ? (opts.body instanceof FormData ? opts.body : JSON.stringify(opts.body)) : undefined,
        signal: opts.signal
      });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    function renderResults(hits, query) {
      const wrap = document.getElementById('results');
      wrap.innerHTML = '';
      if (!hits || !hits.length) {
        wrap.textContent = 'No results';
        return;
      }
      for (const h of hits) {
        const div = document.createElement('div');
        div.className = 'hit';
        const title = h.title ? escapeHtml(h.title) : '';
        const source = h.source_path ? escapeHtml(h.source_path) : '';
        const distance = (h.distance !== null && h.distance !== undefined) ? `distance: ${h.distance.toFixed ? h.distance.toFixed(4) : h.distance}` : '';
        const rank = (h.rank !== null && h.rank !== undefined) ? `rank: ${h.rank.toFixed ? h.rank.toFixed(4) : h.rank}` : '';
        div.innerHTML = `
          <div class="hit-head">
            <div class="hit-title">${title || '(untitled)'}</div>
            <div class="hit-badges">${distance ? `<span class="badge">${distance}</span>` : ''}${rank ? `<span class="badge">${rank}</span>` : ''}</div>
          </div>
          <div class="hit-meta">${source}</div>
          <div class="hit-content">${highlight(h.content || '', query)}</div>
        `;
        wrap.appendChild(div);
      }
    }

    let currentSearchController = null;
    let searchTimer = null;

    async function doSearch() {
      const query = document.getElementById('query').value.trim();
      const mode = document.getElementById('mode').value;
      const topk = parseInt(document.getElementById('topk').value || '6', 10);
      const ans = document.getElementById('answer');
      const loading = document.getElementById('searchLoading');
      const btn = document.getElementById('searchBtn');

      if (!query) { ans.textContent = ''; renderResults([], ''); return; }

      // cancel prior request
      if (currentSearchController) currentSearchController.abort();
      const ctrl = new AbortController();
      currentSearchController = ctrl;

      loading.hidden = false;
      btn.disabled = true;
      ans.textContent = '';

      try {
        const data = await api('/api/search', { method: 'POST', body: { query, mode, top_k: topk }, signal: ctrl.signal });
        if (data.answer) ans.textContent = data.answer;
        renderResults(data.hits, query);
      } catch (e) {
        if (e.name !== 'AbortError') {
          showToast('Search failed');
          console.error(e);
        }
      } finally {
        if (currentSearchController === ctrl) currentSearchController = null;
        loading.hidden = true;
        btn.disabled = false;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', () => doSearch());

    document.getElementById('query').addEventListener('input', () => {
      const auto = document.getElementById('autoSearch')?.checked ?? true;
      const delay = parseInt(document.getElementById('debounceMs')?.value || '400', 10);
      if (auto) {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => doSearch().catch(console.error), delay);
      }
    });

    document.getElementById('mode').addEventListener('change', () => {
      if (document.getElementById('autoSearch').checked) doSearch();
    });
    document.getElementById('topk').addEventListener('change', () => {
      if (document.getElementById('autoSearch').checked) doSearch();
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      const p = document.getElementById('settingsPanel');
      const b = document.getElementById('settingsBtn');
      const nowHidden = !p.hidden;
      p.hidden = nowHidden;
      b.setAttribute('aria-expanded', String(!nowHidden));
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const input = document.getElementById('files');
      const status = document.getElementById('uploadStatus');
      const loading = document.getElementById('uploadLoading');
      status.textContent = '';
      const files = input.files;
      if (!files || !files.length) { showToast('No files selected'); return; }
      const form = new FormData();
      for (const f of files) form.append('files', f);
      loading.hidden = false;
      try {
        const data = await api('/api/upload', { method: 'POST', body: form });
        status.textContent = JSON.stringify(data, null, 2);
        showToast('Upload complete');
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        showToast('Upload failed');
      } finally {
        loading.hidden = true;
      }
    });

    document.getElementById('readyBtn').addEventListener('click', async () => {
      const box = document.getElementById('readyJson');
      try {
        const data = await api('/api/ready');
        box.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        box.textContent = 'Error: ' + e.message;
      }
    });
  </script>
</body>
</html>
